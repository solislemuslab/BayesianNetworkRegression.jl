# Test of fit! in toy data

## global seed
rng = Xoshiro(1234)

## simulating 10 4x4 adjacency matrices
X = [rand(rng,Bernoulli(0.5),4,4)]
for i in 1:9
     push!(X,rand(rng,Bernoulli(0.5),4,4))
end

y = ones(size(X,1))*12 + rand(rng, Normal(0,2),size(X,1))

R  = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, nburn=300, nsamples=100, x_transform=true, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Toy Generate Samples - Parameters" begin
     @test res.state.τ²[1:10] ≈ [1.0, 101.41424942936129, 47.97969583733759, 59.4600561754357, 23.297977045064084, 26.76472275208744, 23.702039287935598, 27.62678525140863, 20.216915536781585, 6.972734003664796]
     @test mean(res.state.τ²) ≈ 3.9096624280660173 rtol=1.0e-5
     @test res.state.u[1:10,1:5,1] ≈ [1.206963650967598 0.42989452602078787 -0.1402344379261064 1.1532395934572193 -1.6110199386770607; -0.0 0.0 0.0 -0.0 -0.0; 0.07558566093967702 0.5464190980252831 0.4603442556319787 0.8845610595603592 0.10339928038984687; -0.0 -0.0 0.0 -0.0 0.0; 0.0 -0.0 -0.0 -0.0 0.0; 0.0 -0.0 0.0 0.0 -0.0; 0.0 -0.0 -0.0 -0.0 0.0; -0.07290820772000313 -0.6402760244738072 0.1643431054910149 0.30256206143650044 -0.530801115544624; 0.0011591805570598116 -0.2658427344835206 0.05051380160183541 -0.05086873316234989 0.16812812813004338; -0.3150637492636513 0.05364870262923169 -0.4849141053558922 0.16300482683147446 0.570823053460454] rtol=1.0e-5
     @test mean(res.state.u) ≈ 0.006150080422008666 rtol=1.0e-5
     @test res.state.ξ[1:10,:,1] ≈ [1.0 1.0 1.0 0.0; 
                                    0.0 0.0 1.0 0.0; 
                                    1.0 0.0 0.0 1.0; 
                                    0.0 0.0 0.0 1.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 1.0 0.0; 
                                    1.0 0.0 1.0 0.0; 
                                    1.0 0.0 1.0 0.0; 
                                    1.0 0.0 0.0 1.0] rtol=1.0e-5
     @test mean(res.state.ξ) ≈ 0.448125 rtol=1.0e-5
     @test res.state.γ[1:10,:,1] ≈ [-2.7704810578421846 -2.9976377165912638 -0.477440051406965 0.4770348348884931 -1.2704965572707658 2.0864689877217195; 13.54125185981427 0.7638239665835788 -0.3441351072610521 2.956672137463882 7.963847385533639 -0.2831606593026188; -4.621709187928629 4.523071621566972 -0.6939623399419612 20.42766659377838 4.9090569443006915 4.055114737001763; -3.0419781425211587 1.9276513676510092 3.811071260066049 9.764359807713783 7.2095712549670505 8.97406874741776; -4.303274339775195 -0.7908848500184811 4.103482187373063 5.872287737086141 5.331848594993643 11.315257421232447; 1.8883241451828088 -2.869318462906691 -3.2306648513677736 8.404199953156835 1.0340887255786493 7.919338338718317; -4.1900239279935265 -1.0794882848298784 3.5045168471849886 4.804399634386169 0.46060466767261143 -3.273268219739477; 0.9703122897567651 0.438768478557355 -5.934477630370361 -0.6581452049167821 -0.6628043655572764 1.3454586603395762; -0.9874987398086432 0.4275731498296452 0.3287492767643143 1.614945352645854 -1.0785994263634469 -1.1242584065523566; -0.11991401862535644 0.07166374973316368 2.4778373178694064 0.03069662914113369 0.1706864796366312 1.3808482164451474] rtol=1.0e-5
     @test mean(res.state.γ) ≈ 0.8299819091471434 rtol=1.0e-5
     @test res.state.S[1:10,:,1] ≈ [0.34233439253944253 0.08679402653200143 0.2876506724224301 0.11599335928212713 0.49702168040092953 0.03454919449156262; 3.216805785448195 1.8642685695728822 4.4889982662327 2.756112047237176 0.7596335764624882 0.4398744332632828; 0.8836055985997177 3.9254386696012484 4.270025540815997 13.613769054111497 1.35302941818768 3.468048218605219; 8.189208509852218 0.3715649897645801 0.8131688989517407 2.0475212423293643 2.464326392916076 1.6035147900741946; 1.6340778367827302 1.340572532321514 0.39959148523508475 1.5682648094281813 0.7137423655275403 1.79022065447528; 1.9225725674936536 2.7985626738246023 1.1009792292883518 3.0798381531104226 0.12090974469847506 0.9863820141551602; 1.2733996003720915 0.075042130114545 1.7786694462177 1.7452722482425256 1.1053871283417318 0.17681386826818704; 0.16947418916996967 0.30998837154849357 0.39416073296456083 0.030177366307856102 0.16374859395472854 0.21603235449445587; 0.6014965436233716 0.021594345280864426 0.41511224880687564 0.3347298169679376 0.5844495461460341 0.15634181723322477; 0.11177574732727087 0.0057776490328882825 0.6745691854606028 0.003053810601506615 0.009682399888365948 0.15633002647798108] rtol=1.0e-5
     @test mean(res.state.S) ≈ 1.7605376274307496 rtol=1.0e-5
     @test res.state.θ[1:10] ≈ [0.5, 0.5257660614376696, 0.37373000254148675, 1.4242358426376556, 1.0234552934797736, 0.9490031895284712, 1.5190903302599987, 3.0515446892335225, 6.284932275204935, 3.7777486043828303] rtol=1.0e-5
     @test mean(res.state.θ) ≈ 1.5734702384139425 rtol=1.0e-5
     @test res.state.Δ[1:10,:,1] ≈ [0.5; 
                                    0.16678844773792914; 
                                    0.6165156741916015; 
                                    0.07466820012939777; 
                                    0.09146195358433883; 
                                    0.18296491589742034; 
                                    0.3529333169141577; 
                                    0.5484466229202484; 
                                    0.39672085965104953; 
                                    0.25049485623768036] rtol=1.0e-5
     @test mean(res.state.Δ) ≈ 0.45199750984518167 rtol=1.0e-5
     @test res.state.M[1:10,:,1] ≈ [0.881540000708377 -0.3512316919755819 0.22838870235042902 -0.35421488439668614 0.506619979289262; 
                                   0.1994243529604618 0.08779429185144555 0.024671907642035754 0.12722635650375894 -0.013846203166549055; 
                                   0.3301045069695512 0.19663321523423216 0.08316875607504504 0.13630756547293651 -0.14943084257080252; 0.07058730317599918 -0.02258673250616543 0.0026952905449810663 -0.028089903621344763 -0.007785985681764305; 
                                   0.48924547431709153 -0.04854352191161418 0.011849493231733649 -0.06886831192757249 -0.05438160304124514; 
                                   0.15514716935449352 0.0025390350703312727 -0.01177700024780509 0.0047423467479287195 0.008625557386013344; 
                                   0.13307712130683336 0.02732057299637946 -0.00896860108537113 0.03171453966497141 0.010729376650963135; 
                                   0.10784716723468148 -0.016686000895340225 -0.003100759821282539 0.009629574597714984 -0.029131337408285624; 
                                   0.2031899059955093 0.08132645061974986 -0.041935379226520485 -0.056037478888808306 -0.009510644325347192; 
                                   0.14731302120593137 0.015491317909481564 0.027686120301626673 -0.03649150993231384 -0.008998970795227863] rtol=1.0e-5
     @test mean(res.state.M) ≈ 0.047823255532423274 rtol=1.0e-5
     @test res.state.μ[1:10] ≈ [1.0, -1.0341061428687763, -4.311657319482759, 2.890020596956728, 4.621981242257149, 9.128818629244789, 11.927165932591947, 11.498808445917781, 10.0101437823978, 10.29902456997722] rtol=1.0e-5
     @test mean(res.state.μ) ≈ 10.448383885563072 rtol=1.0e-5
     @test res.state.πᵥ[1:10,:,1] ≈ [0.2353756187661488 0.5373651490185535 0.7635620371420891 0.9398198836397634 0.4087228186206146; 
                                     0.21994007897623144 0.869326531754684 0.5942289344973415 0.8086281937338461 0.5116112610137004; 0.30504026927650557 0.5000901958912926 0.9459489043442024 0.8752439307455127 0.7620818224333348; 
                                     0.3563571680024196 0.4812309373349265 0.25338630734696044 0.9548855904050575 0.7439063131819832; 
                                     0.3934799684435616 0.5234242741436936 0.21513117430881035 0.7572875108209951 0.522451618713496; 0.6265733298124304 0.4060499548422176 0.5047917519741009 0.7192907479883701 0.4977532407985467; 
                                     0.2556276423967664 0.5726649599552479 0.1250297755370487 0.7937017298351491 0.7907364915740324; 
                                     0.8193983896225803 0.41657371330554344 0.22163986096775096 0.6042636889281933 0.7570721734582044; 
                                     0.8885915552175071 0.7375821224015967 0.43367659387642077 0.46128071854197705 0.7879869706408584; 
                                     0.37884100033138907 0.4546294055618639 0.6777005147199641 0.4471014759335576 0.5306224613246625] rtol=1.0e-5
     @test mean(res.state.πᵥ) ≈ 0.3333333333333333 rtol=1.0e-5
end


@testset "Toy Generate Samples - Rhat" begin
     @test res.rhatξ.ξ ≈ [1.0232239939388403, 0.9935558789879575, 1.0046890066085128, 1.0157926514519593] rtol=1.0e-5
     @test res.rhatγ.γ ≈ [0.9932082370693708, 1.0082202535451616, 0.9901859540429983, 0.9906814177430046, 1.0023998832104648, 0.9914748234925566] rtol=1.0e-5
end

@testset "Toy Generate Samples - Summary" begin
     out = Summary(res);
     @test out.edge_coef[!,:estimate] ≈ [0.916, 0.66, 2.249, 0.456, -0.625, 0.563] rtol=1.0e-5
     @test out.prob_nodes[!,:probability] ≈ [0.43, 0.45, 0.42, 0.46] rtol=1.0e-5
end