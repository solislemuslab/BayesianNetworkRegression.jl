# Test of fit! in toy data

## global seed
rng = Xoshiro(1234)

## simulating 10 4x4 adjacency matrices
X = [rand(rng,Bernoulli(0.5),4,4)]
for i in 1:9
     push!(X,rand(rng,Bernoulli(0.5),4,4))
end

y = ones(size(X,1))*12 + rand(rng, Normal(0,2),size(X,1))

R  = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, nburn=300, nsamp=100, maxburn=300, psrf_cutoff=1.2, x_transform=true, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Toy Generate Samples - Parameters" begin
     @test res.state.τ²[1:10] ≈ [1.0, 62.5532736212109, 23.912961921944532, 9.884036285817954, 8.64899242352004, 11.381242452838524, 10.656320076294389, 6.719854765372613, 4.480527357284866, 2.97376141663668] rtol=1.0e-5
     @test mean(res.state.τ²) ≈ 2.7147052218335896 rtol=1.0e-5
     @test res.state.u[1:10,1:5,1] ≈ [1.0473696272971653 -1.2265459317745677 -1.0484703848367365 1.206963650967598 0.42989452602078787; 
                                      0.0 -0.0 0.0 0.0 0.0; 0.0 0.0 0.0 -0.0 0.0; 0.0 -0.0 -0.0 -0.0 0.0; -0.0 -0.0 0.0 -0.0 0.0; 
                                      0.0 0.0 -0.0 0.0 0.0; 0.0 0.0 0.0 0.0 -0.0; 0.0 -0.0 -0.0 -0.0 -0.0; -0.0 -0.0 0.0 0.0 -0.0; 0.0 -0.0 -0.0 0.0 0.0] rtol=1.0e-5
     @test mean(res.state.u) ≈ 0.0022299550485789512 rtol=1.0e-5
     @test res.state.ξ[1:10,:,1] ≈ [1.0 1.0 0.0 0.0; 
                                    0.0 0.0 0.0 1.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0; 
                                    0.0 0.0 0.0 0.0] rtol=1.0e-5
     @test mean(res.state.ξ) ≈ 0.488125 rtol=1.0e-5
     @test res.state.γ[1:10,:,1] ≈ [-0.257976755042629 -1.3005873467427367 1.4777807929346276 -0.6324802023648892 -0.341485204193081 -1.5932315619663877 0.12652765083589412 1.0360669192712042 0.4099255372481429 0.9411958853625514; 
                                    -3.471055001284326 -1.8451729323095667 3.271937511315631 -0.3987575785111065 5.929666895858138 0.41411112298720504 -5.33086158496544 4.257148675724655 -1.8287299517066193 9.011223515501714; 1.3259662897713227 -0.8182143081595323 -0.371504153833639 -6.441321347380589 5.5549484092736705 2.741237627025299 4.241220409593996 4.5593559427524495 0.30736390834763916 5.236516711730996; 
                                    3.5684203796271383 -9.007749325001413 6.020526434752378 2.8655533814696454 2.3004871341569295 9.662388271209654 4.203156226939963 1.1766422317610945 3.008216790110979 0.4403625383905636; 3.379460179551759 -0.7396157716976983 3.5017986902712104 2.661457820140232 -0.2457529112506549 4.430189040667305 5.665175104618517 0.16778477191566843 1.8732734838865566 1.9406210379252746; 
                                    -1.1814678485083459 -7.270762919964214 6.087779007218945 6.375090762789901 5.235222313331563 4.01659652137427 1.2799927716532755 3.388897118930725 3.0004692046387955 1.4326032806125952; 1.6465596199944845 3.3467252832361263 1.9676053974704102 4.529357202436636 2.857828601331013 2.328257350660989 4.7294184287293675 -1.2885839640647294 0.9445737964661607 -1.2950799465465064; 
                                    1.021792770593878 2.2006757491213307 3.4354924679560543 1.531875431076663 1.0587863630741063 -0.28286657489694234 0.2363931487491051 0.8255055197004677 1.3956299555342833 1.3008389536170695; -1.5636639805004617 -7.913199590162145 2.373363942602428 -0.26280142714960664 2.0826452330840017 5.783811529869222 1.2609665802172967 0.868267860434273 -1.3022979283869862 3.765613565327687; 
                                    0.1627474401878486 -3.298839821006734 3.0400233409785504 -2.773222250924624 -0.9814733563474586 6.123976128651717 2.444657207208835 -1.0420481061796558 -0.6378985830099091 1.7333881772885733] rtol=1.0e-5
     @test mean(res.state.γ) ≈ 0.5607426230474925 rtol=1.0e-5
     @test res.state.S[1:10,:,1] ≈ [0.34233439253944253 0.08679402653200143 0.2876506724224301 0.11599335928212713 0.49702168040092953 0.03454919449156262 0.10950704826034448 0.18987897418052874 0.16585778163019455 0.4041135970940934; 11.001075438434402 0.09498065828789687 0.27191227448259614 2.19223750188109 5.125893226579564 4.608638778196067 5.161357324526458 2.242096935092428 0.20388453281382815 4.380795463643178; 29.12670500600789 9.881014538785665 1.6158970763202123 6.22027027138029 3.1042020698164747 5.7637428789434315 23.96903195964952 13.01517212938838 0.7922088282121601 6.785776894334643; 7.9348039368380885 6.714897322055629 1.9580261649101256 4.823362323045469 20.278489502001065 21.31198781313955 18.484053256809712 9.78771402280047 0.4796008704059506 1.6278675826628894; 3.7509442776258153 2.162684655223192 5.587266425820896 3.243223019139455 4.42238401347864 3.091992190461831 2.2279134059522123 5.499259340497065 2.290237933487023 2.35978363479167; 0.3566296584297196 4.81520095870538 5.42948036381634 2.5185092608269204 2.1616441656091503 3.2607203127659097 3.6695320905949567 0.8677786094647645 10.777620078260405 0.6065504127824329; 0.11645901857692392 7.247621733469514 0.8028867241108826 7.502749689731321 3.0102300038168304 0.6749999537164056 6.661894166074343 3.063806973725758 3.865983237363139 3.744010458025051; 5.731748444045074 5.848408141011814 2.4768671883343627 1.3858683252328576 1.2678906258335179 8.226128962680397 0.5596027097784585 4.344358315982409 4.167262986485536 7.358748067273321; 0.548435456869503 7.910631596170781 0.5450054553667134 4.685871660446308 0.9904421207678752 4.210810928475235 2.135006025247359 0.6791838454463212 0.9024370383126892 4.5453347842735505; 0.8611447322467333 4.113357734521016 4.1406026146508275 4.4480046844905266 0.4043379521529894 9.382213575641247 1.2217639698168887 11.107939351490058 18.191936119393585 1.2166424324739957] rtol=1.0e-5
     @test mean(res.state.S) ≈ 2.8426906377728827 rtol=1.0e-5
     @test res.state.θ[1:10] ≈ [0.5, 0.27308978647125187, 0.127186657175247, 0.21380755936409532, 0.6973146126983812, 0.5078098174999636, 0.4036530985808252, 0.7135255090318673, 0.7701286296269042, 0.243725265581881] rtol=1.0e-5
     @test mean(res.state.θ) ≈ 1.1696479237406237 rtol=1.0e-5
     @test res.state.Δ[1:10,:,1] ≈ [0.5; 0.10819012902956243; 0.06217559523061749; 0.06938190015202833; 0.18267561877896696; 0.12094321737213219; 0.08658143540295422; 0.016439521977475943; 0.008356393577659748; 0.2828807329889493] rtol=1.0e-5
     @test mean(res.state.Δ) ≈ 0.49612189997748224 rtol=1.0e-5
     @test res.state.M[1:10,:,1] ≈ [0.132828581104893 -0.045035983615788304 -0.0038359275308435885 -0.03533915829244388 0.06520964766881399; 0.2337054284945323 -0.014365370886708613 0.03324427778609587 0.031841026663264604 -0.07401596959915385; 1.0654616898778626 -1.3460336499626329 -0.9610816835740196 -0.6075656965188738 1.0685293986157; 0.2833256646756551 0.19471800862242486 -0.03994400028847471 0.0036493567902126526 -0.16049062075416007; 0.22603426734347418 0.16395025614522873 -0.08035683185683955 0.14605608620731064 0.22605322013065948; 0.09799683420527042 0.011698020369860744 0.018870436918611205 -0.06522147416029855 0.09063476159171642; 0.4922201424895039 -0.1485840971838537 0.1503047746297793 -0.29043811888589954 -0.05357065888305513; 0.18937285527659664 -0.09019474156298399 0.03137312428340068 -0.08037211469731798 0.07246902434395212; 1.0004267601475503 0.8926323103042351 0.03745181980902221 -0.011743585137396673 0.4197753810714632; 0.2496445019412428 0.16558694827303513 0.05406519371326688 0.10562330512835887 0.026281368062782615] rtol=1.0e-5
     @test mean(res.state.M) ≈ 0.04751366711491954 rtol=1.0e-5
     @test res.state.μ[1:10] ≈ [1.0, 1.1967600669405312, -0.07989628013115779, -0.06567773252727649, 1.6997370866786539, 4.480120714612116, 5.654457240189921, 6.724214795369942, 8.240753467268734, 8.677217355832903] rtol=1.0e-5
     @test mean(res.state.μ) ≈ 9.002761262948969 rtol=1.0e-5
     @test res.state.πᵥ[1:10,:,1] ≈ [0.12039685456251642 0.5987127325072312 0.9435764720512527 0.5855371290803323 0.3403274171981944; 0.20317313695978212 0.7976056004544234 0.5497123819367751 0.881644297879368 0.5611965464342643; 0.27194750550355085 0.6855121919181177 0.7467974436551746 0.3836232996205176 0.864017286068815; 0.5643824080290802 0.7738589185361364 0.4898728786022727 0.40769043492664914 0.6191130683238167; 0.25112257010211947 0.8587657509319792 0.9042468793747588 0.4792349039467461 0.6133818888182617; 0.4177842065083691 0.8294706089676616 0.9468432138663359 0.20377320467936855 0.8379621877260671; 0.16171860496252008 0.20633530603894412 0.8575227048054891 0.4022817039257593 0.5570730266672582; 0.07214890240105523 0.4492946461867548 0.3138971523655119 0.7937752714566221 0.8245580034890173; 0.07791064260472916 0.49080272475385095 0.6623884646712342 0.677858432494835 0.6775013461903476; 0.4971998073251118 0.2085461276861162 0.6645533927887712 0.8180028031845997 0.8684438798411452] rtol=1.0e-5
     @test mean(res.state.πᵥ) ≈ 0.3333333333333333 rtol=1.0e-5
end


@testset "Toy Generate Samples - Rhat" begin
     @test res.rhatξ.ξ ≈ [1.0000989233840814, 1.0160052493302714, 1.0000989233840814, 1.0097464032349095] rtol=1.0e-5
     @test res.rhatγ.γ ≈ [0.9911954836179075, 1.0437579974594033, 1.1730461071582396, 1.003661801365217, 0.9904992455662877, 1.0046214476649962, 1.0170522929915229, 1.0628375111592903, 1.0303581451131982, 1.0522631351345995] rtol=1.0e-5
end

@testset "Toy Generate Samples - Summary" begin
     out = Summary(res);
     @test out.edge_coef[!,:estimate] ≈ [0.274, -0.236, 2.015, -1.412, 0.251, 2.204, 1.609, 0.513, 0.482, 0.751] rtol=1.0e-5
     @test out.prob_nodes[!,:probability] ≈ [0.57, 0.56, 0.57, 0.55] rtol=1.0e-5
end