# Test of fit! in toy data

## global seed
rng = Xoshiro(1234)

## simulating 10 4x4 adjacency matrices
X = [rand(rng,Bernoulli(0.5),4,4)]
for i in 1:9
     push!(X,rand(rng,Bernoulli(0.5),4,4))
end

y = ones(size(X,1))*12 + rand(rng, Normal(0,2),size(X,1))

R  = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, nburn=300, nsamples=100, x_transform=true, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Toy Generate Samples - Parameters" begin
     @test res.state.τ²[1:10] ≈ [1.0, 112.48351549161899, 48.65013165200324, 63.56711614064913, 24.024484130858937, 
                                 36.757039009218296, 47.50457241041853, 55.95986786626281, 22.449819463160328, 5.814343656159123]
     @test mean(res.state.τ²) ≈ 3.149963274299994 rtol=1.0e-5
     @test res.state.u[1:10,1:5,1] ≈ [1.206963650967598 0.42989452602078787 -0.1402344379261064 1.1532395934572193 -1.6110199386770607; 
                                     -0.0 0.0 0.0 -0.0 -0.0; 
                                     0.07839783155333928 0.5420048794223619 0.4653714309499843 0.8834774872546236 0.1033981216724633; 
                                     -0.0 -0.0 0.0 -0.0 0.0; 0.0 -0.0 -0.0 -0.0 0.0; 
                                     -0.010852686832887589 -0.27341472282924834 0.5132323861171746 0.42725149578131905 -0.022060812224346724; 
                                     -0.44535620164369244 -0.5417933941455162 0.4363326980003392 0.8973809596245079 -0.6510496686137505; 
                                     -0.5384040509175557 0.15644000205137704 -0.2534772279035551 1.1622914144404048 0.2503600339180876; 
                                     0.11650874048239904 -0.045001860517614754 0.07528703475838688 0.43920404476428654 -0.23087814343913093; 
                                     0.23937085800165903 -0.6457638462811061 0.12527227998674031 1.009812188614304 1.2701847952207381] rtol=1.0e-5
     @test mean(res.state.u) ≈ -0.006738001152876486 rtol=1.0e-5
     @test res.state.ξ[1:10,:,1] ≈ [1.0 1.0 1.0 0.0; 
                                    0.0 0.0 1.0 0.0; 
                                    1.0 0.0 0.0 1.0; 
                                    0.0 0.0 0.0 1.0; 
                                    0.0 0.0 0.0 0.0; 
                                    1.0 1.0 0.0 1.0; 
                                    1.0 1.0 1.0 1.0; 
                                    1.0 1.0 1.0 1.0; 
                                    1.0 1.0 1.0 1.0; 
                                    1.0 1.0 0.0 1.0] rtol=1.0e-5
     @test mean(res.state.ξ) ≈ 0.47 rtol=1.0e-5
     @test res.state.γ[1:10,:,1] ≈ [-2.7704810578421846 -2.9976377165912638 -0.477440051406965 0.4770348348884931 -1.2704965572707658 2.0864689877217195; 
                                     13.697531722021171 0.9909811058435217 -1.8392688574594627 3.0868131181148826 9.683459883208462 -0.3952078762116322; 
                                     -5.1670433358945065 5.232676838184787 -6.424940770009655 22.073072800868633 6.79978137651022 3.6263430002965427; 
                                     -3.674950339142195 2.4129754569405257 -1.7870729628676867 11.53173018685806 9.492322438459428 8.180192125615354; 
                                     -5.70997959196113 -0.22696225047247953 0.8213211712788756 7.365585068792479 7.767263944020288 10.564498426379581; 
                                     2.0356945450377335 -1.866375502188641 -5.4778921284247195 8.963909766366466 2.9364446789304326 8.681545210268279; 
                                     3.513109656094968 4.461661167676938 -6.107177649376763 5.840752969414458 2.8210828082175237 -3.3897612495716047; 
                                     -3.3999781899713395 3.24311033832342 -11.09082699532489 10.064048404733676 3.390213865165898 2.696748941157354; 
                                     0.8002141688475949 5.027402336245698 1.1652093687913525 4.860677142772788 3.191261214971974 -0.7487592018609013; 
                                     0.4780359874918383 3.7077232947997456 -1.0376955612501377 3.054933036533951 1.72724095740888 -0.8502866498780248] rtol=1.0e-5
     @test mean(res.state.γ) ≈ 0.7767112498124501 rtol=1.0e-5
     @test res.state.S[1:10,:,1] ≈ [0.34233439253944253 0.08679402653200143 0.2876506724224301 0.11599335928212713 0.49702168040092953 0.03454919449156262; 
                                    3.1341198403265933 1.8872865612166199 4.988295382423799 2.7437977525873625 0.8260211817312565 0.44767013213779383; 
                                    0.958953336915411 4.342937432626904 0.492733257217772 14.67858104998472 1.6664628395284313 3.327564791163665;
                                    8.422027511844291 0.38703905760090607 0.11955484424991145 2.1193796535842866 2.704841747813398 1.4139729616109098; 
                                    1.9430260916925266 1.2181007293333697 0.4823613177762626 0.88448701998331 1.2921342583455557 1.4078079655369693; 
                                    1.810104288150739 1.8892454085091523 1.308035836988073 2.705363625139322 0.18065582078451434 0.8844004406506335; 
                                    1.7720742247684276 0.776350482378578 1.6693789105208348 3.4989297010530596 0.20342022408957722 0.12080331002455372; 
                                    0.21987589121893894 0.1750456841284906 3.3451685923416914 1.4862817148408005 0.28760611507781336 0.8848203167550784; 
                                    0.6626376906348181 0.9259243163591022 1.1723479913501085 2.2803125412932954 0.5953617813532771 0.950440760653788; 
                                    6.065073066049223 1.4870375550463315 0.7590578645235225 3.146850271299134 0.7100859738154115 0.40704442442910366] rtol=1.0e-5
     @test mean(res.state.S) ≈ 4.381543917453874 rtol=1.0e-5
     @test res.state.θ[1:10] ≈ [0.5, 0.5093145995888615, 0.4015779895270753, 1.4509909768356637, 1.12548647197062, 1.0574333807792227, 1.5437343856886303, 
                                2.235055864117217, 1.4768967226687635, 0.7384983187658976] rtol=1.0e-5
     @test mean(res.state.θ) ≈ 1.0403216994827968 rtol=1.0e-5
     @test res.state.Δ[1:10,:,1] ≈ [0.5; 
                                   0.16678844773792914; 
                                   0.6165156741916015; 
                                   0.07466820012939777; 
                                   0.720947750483095; 
                                   0.9388496815978722; 
                                   0.9694214180412173; 
                                   0.9838394373132214; 
                                   0.8113047920288164; 
                                   0.9034861738873836] rtol=1.0e-5
     @test mean(res.state.Δ) ≈ 0.46747773426839856 rtol=1.0e-5
     @test res.state.M[1:10,:,1] ≈ [0.881540000708377 -0.3512316919755819 0.22838870235042902 -0.35421488439668614 0.506619979289262;
                                    0.20090098304989024 0.08960565037750179 0.021630138569406425 0.1286093800536634 -0.013356706385591445; 
                                    0.3325912163824048 0.19652621483185995 0.08493558525620207 0.13767101161073902 -0.15094109001231748; 
                                    0.06941239048344687 -0.02432880230081665 0.0015115187930821606 -0.029347744832140664 -0.006202230817010535; 
                                    0.1482407701570161 -0.03856706968701688 -0.05012331585750318 0.004258352679553528 -0.050616213206000966; 
                                    0.13629877822957537 0.0311748738978342 -0.041964995300631545 -0.06875386196441023 0.05691192563180033; 
                                    0.15231579081467655 0.004555714681285614 -0.04196828164799481 0.008453339160009354 0.07006681870287423; 
                                    0.387618275470373 -0.019309754126214183 0.057562474783661756 -0.14950387589826025 0.02312796708988867; 
                                    0.3630422143397611 -0.0976524221140268 -0.015659184936295062 -0.06696043219209419 0.1321911785254746; 
                                    0.3578400592698511 0.10672446565071177 -0.14731195954072954 -0.039433112580306164 -0.006713889548806988] rtol=1.0e-5
     @test mean(res.state.M) ≈ 0.04900731953198754 rtol=1.0e-5
     @test res.state.μ[1:10] ≈ [1.0, -1.500561526864841, -4.79815109438014, 2.543734506309614, 3.0302851142636187, 1.5319929569204738, 
                                6.026192811012265, 5.438701375656482, 7.43381925599009, 8.008998129482878] rtol=1.0e-5
     @test mean(res.state.μ) ≈ 9.538832806529904 rtol=1.0e-5
     @test res.state.πᵥ[1:10,:,1] ≈ [0.2353756187661488 0.5373651490185535 0.7635620371420891 0.9398198836397634 0.4087228186206146; 
                                     0.21994007897623144 0.869326531754684 0.5942289344973415 0.8086281937338461 0.5116112610137004; 
                                     0.30504026927650557 0.5000901958912926 0.9459489043442024 0.8752439307455127 0.7620818224333348; 
                                     0.3563571680024196 0.4812309373349265 0.25338630734696044 0.9548855904050575 0.7439063131819832; 
                                     0.04430021748206718 0.6023682252586824 0.8238736314392421 0.7861554547533157 0.7515528927101601; 
                                     0.023812547703283934 0.33966622860361123 0.8072675964581124 0.4817264551583188 0.6311402796153006; 
                                     0.04582591780359378 0.039339467601262605 0.7571135170098834 0.7598225466464148 0.8958903823259075; 
                                     0.3538084904198491 0.2216571307011348 0.7301321390455012 0.865111619174462 0.8623682925381562; 
                                     0.2779166900802174 0.48493075039115346 0.294848619866568 0.9557995523721357 0.8479662359385493; 
                                     0.07399726402792818 0.3468415798390059 0.2950947037774853 0.6113955253088913 0.6168222037242453] rtol=1.0e-5
     @test mean(res.state.πᵥ) ≈ 0.3333333333333333 rtol=1.0e-5
end


@testset "Toy Generate Samples - Rhat" begin
     @test res.rhatξ.ξ ≈ [0.9999029864016991, 1.02268055553638, 1.0395901420999538, 1.0600201277769592] rtol=1.0e-5
     @test res.rhatγ.γ ≈ [1.0132950733926034, 0.9899511395694416, 1.0129070799260695, 1.2685612650813038, 1.3170993742490387, 1.0578286366769858] rtol=1.0e-5
end

@testset "Toy Generate Samples - Summary" begin
     out = Summary(res);
     @test out.edge_coef[!,:estimate] ≈ [0.209, 1.724, -1.669, 2.047, 1.766, 0.211] rtol=1.0e-5
     @test out.prob_nodes[!,:probability] ≈ [0.49, 0.47, 0.45, 0.45] rtol=1.0e-5
end