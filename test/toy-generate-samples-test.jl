# Test of fit! in toy data

## global seed
rng = Xoshiro(1234)

## simulating 10 4x4 adjacency matrices
X = [rand(rng,Bernoulli(0.5),4,4)]
for i in 1:9
     push!(X,rand(rng,Bernoulli(0.5),4,4))
end

y = ones(size(X,1))*12 + rand(rng, Normal(0,2),size(X,1))

R  = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, nburn=300, nsamples=100, x_transform=true, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Toy Generate Samples - Parameters" begin
     @test res.state.τ²[1:10] ≈ [1.0, 37.61399768932796, 15.491725906600811, 8.556618385974353, 5.6723596188580965, 3.5617803819102294, 1.0462284143217724, 2.0225200116464306, 9.00412015765615, 64.11675539053448] rtol=1.0e-5
     @test mean(res.state.τ²) ≈ 2.7052682084250677 rtol=1.0e-5
     @test res.state.u[1:10,1:5,1] ≈ [0.263036   1.62807   -1.40734    -0.381808   0.104664
                                        -0.0        0.0        0.0        -0.0       -0.0
                                        0.0       -0.0       -0.0        -0.0       -0.0
                                        -1.73696    0.578656   0.829241    1.30736   -0.165508
                                        0.0       -0.0       -0.0        -0.0        0.0
                                        0.0       -0.0       -0.0        -0.0       -0.0
                                        0.164771   0.654233  -0.0613017   0.402963  -0.739363
                                        0.0       -0.0        0.0        -0.0        0.0
                                        0.0        0.0       -0.0         0.0       -0.0
                                        0.546734  -0.234876   0.630624    0.597594  -0.509048] rtol=1.0e-5
     @test mean(res.state.u) ≈ 0.004153305695915034 rtol=1.0e-5
     @test res.state.ξ[1:10,:,1] ≈ [ 0.0  0.0  0.0  0.0
                                   0.0  0.0  1.0  0.0
                                   0.0  0.0  0.0  0.0
                                   1.0  0.0  0.0  0.0
                                   0.0  1.0  0.0  0.0
                                   0.0  0.0  0.0  0.0
                                   1.0  0.0  0.0  0.0
                                   0.0  0.0  0.0  1.0
                                   0.0  0.0  1.0  0.0
                                   1.0  1.0  1.0  1.0] rtol=1.0e-5
     @test mean(res.state.ξ) ≈ 0.574375 rtol=1.0e-5
     @test res.state.γ[1:10,:,1] ≈ [0.985173   -0.20799    0.48109   -0.277523  -0.472479  -1.62146
                                   1.54824     1.61381    4.8604     1.28236    9.48569    0.471563
                                   3.19831     4.66124   -1.03735    0.24243    3.39254   -0.962692
                                   -0.796305    1.74603   -4.08836    5.65708    3.32803    2.64262
                                   -0.0412969   1.26599   -1.3819     2.67356    4.4274     0.0896385
                                   -1.1464      3.14494   -0.974043   3.83025    1.83917    0.350328
                                   -0.66064     2.45409   -0.538075   2.20744    1.03345    0.0903208
                                   -2.67386     3.27353   -0.191987   3.72401    1.58984   -0.759217
                                   2.46185     5.5115    -5.13042    0.301106  -1.63663   -0.532008
                                   -12.3508      0.862208   4.21905    4.25784    3.6321    -1.43219] rtol=1.0e-5
     @test mean(res.state.γ) ≈ 0.6180881764632244 rtol=1.0e-5
     @test res.state.S[1:10,:,1] ≈ [0.342334  0.086794   0.287651  0.115993  0.497022  0.0345492
                                   0.971609  1.25376    2.91507   2.87323   3.52862   1.86563
                                   0.278602  1.53496    1.1315    1.96713   0.576268  1.26203
                                   2.57275   2.13594    0.4973    0.964076  1.20244   1.36606
                                   1.06303   4.94934    0.320282  3.91988   6.20974   0.75012
                                   0.493327  1.88417    0.616357  5.61413   2.15034   0.281709
                                   3.04225   4.97687    0.134328  1.74909   1.05007   1.63478
                                   0.444751  2.53034    2.74672   0.873008  3.36321   1.83666
                                   4.14007   1.21214    0.280264  0.404416  1.88104   2.42894
                                   4.48394   0.0448067  0.526932  1.40998   0.278316  0.655512] rtol=1.0e-5
     @test mean(res.state.S) ≈ 2.991132926390741 rtol=1.0e-5
     @test res.state.θ[1:10] ≈ [0.5, 1.205863715284874, 2.462542521496453, 0.6439317501719702, 0.5464308207323274, 1.355723923066005, 1.237411137012741, 1.334649926821823, 0.7403309681232427, 0.7471667487576261] rtol=1.0e-5
     @test mean(res.state.θ) ≈ 1.3499524903973046 rtol=1.0e-5
     @test res.state.Δ[1:10,:,1] ≈ [0.5, 0.4407405933489913, 0.05626310958268787, 0.14113096610788992, 0.31839265894546587, 0.41820937031283695, 0.5472759046866421, 0.20491316802699625, 0.6631663035552257, 0.8460774996219184] rtol=1.0e-5
     @test mean(res.state.Δ) ≈ 0.5549098317605053 rtol=1.0e-5
     @test res.state.M[1:10,:,1] ≈ [0.107507    0.0220682   0.00063078   0.0141852     0.0117857
                                   0.256492    0.0785559  -0.117617    -0.000259548   0.0165438
                                   0.886703    0.0638321  -0.435833    -0.607675      0.159305
                                   6.72085    -3.82225    -3.25707     -2.5588        2.20782
                                   1.79472    -0.634081   -0.933941    -0.999877      0.692355
                                   0.140752    0.0332744   0.0351744   -0.0417824    -0.0990989
                                   0.0729588   0.0242707  -0.0104841    0.0298559    -0.0568881
                                   0.218855    0.0785052  -0.01135      0.0964707    -0.0146937
                                   0.397482    0.058533    0.108476     0.231353     -0.0229005
                                   0.209218   -0.0168693   0.0881477    0.111291     -0.0773772] rtol=1.0e-5
     @test mean(res.state.M) ≈ 0.05478605961897075 rtol=1.0e-5
     @test res.state.μ[1:10] ≈ [1.0, 5.847436933197207, 6.392511901922324, 6.635952900771078, 7.861611186881556, 9.73104329243911, 9.366275224516013, 8.957367634895855, 9.423635699942356, 14.807806142306749] rtol=1.0e-5
     @test mean(res.state.μ) ≈ 10.06264760112881 rtol=1.0e-5
     @test res.state.πᵥ[1:10,:,1] ≈ [0.235376   0.796206  0.933231  0.874305  0.919831
                                   0.257465   0.722858  0.595051  0.817051  0.581212
                                   0.0779125  0.717794  0.787933  0.73802   0.758918
                                   0.271948   0.685512  0.746797  0.383623  0.864017
                                   0.391484   0.541154  0.679191  0.455219  0.774813
                                   0.521425   0.8711    0.698028  0.639412  0.823105
                                   0.344742   0.614703  0.204601  0.729716  0.824691
                                   0.119769   0.376115  0.763619  0.625752  0.963826
                                   0.0092232  0.608846  0.597767  0.777909  0.832626
                                   0.297721   0.80477   0.631663  0.751708  0.631023] rtol=1.0e-5
     @test mean(res.state.πᵥ) ≈ 0.33333333333333337 rtol=1.0e-5
end


@testset "Toy Generate Samples - Rhat" begin
     @test res.rhatξ.ξ ≈ [1.004402075571215, 1.0232239939388403, 1.0304382587075984, 0.9903588174304302] rtol=1.0e-5
     @test res.rhatγ.γ ≈ [1.0190420320948104, 1.0211632283437113, 0.9917507008508833, 1.1572688892125815, 1.162704590450527, 1.0964833613585563] rtol=1.0e-5
end