## Initial tests for BayesianNetworkRegression.jl on toy data

## global seed
rng = Xoshiro(1234)

X = [[0, 1, 0, 1,
     1, 0, 1, 1,
     0, 1, 0, 0,
     0, 1, 0, 0],
    [0, 1, 1, 1,
     1, 0, 1, 1,
     1, 1, 0, 0,
     1, 1, 0, 0],
    [0, 0, 1, 0,
     0, 0, 1, 1,
     1, 1, 0, 0,
     0, 1, 0, 0],
    [0, 0, 1, 0,
     0, 0, 1, 1,
     1, 1, 0, 1,
     0, 1, 1, 0]]

Z = BayesianNetworkRegression.symmetrize_matrices(X)

y = ones(size(Z,1))*12 + rand(rng, Normal(0,2),size(Z,1))

η  = 1.01
ζ  = 1.0
ι  = 1.0
R  = 7
aΔ = 1.0
bΔ = 1.0
V = size(Z,1)
q = floor(Int,V*(V+1)/2)
n = size(Z,1)
ν = 10
total = 20

st1 = Table(τ² = Array{Float64,3}(undef,(total,1,1)), u = Array{Float64,3}(undef,(total,R,V)),
                  ξ = Array{Float64,3}(undef,(total,V,1)), γ = Array{Float64,3}(undef,(total,q,1)),
                  S = Array{Float64,3}(undef,(total,q,1)), θ = Array{Float64,3}(undef,(total,1,1)),
                  Δ = Array{Float64,3}(undef,(total,1,1)), M = Array{Float64,3}(undef,(total,R,R)),
                  μ = Array{Float64,3}(undef,(total,1,1)), λ = Array{Float64,3}(undef,(total,R,1)),
                  πᵥ= Array{Float64,3}(undef,(total,R,3)));

X_new = Array{Float64,2}(undef,n,q)
##X_new = rand(rng, Normal(0,2),n,q) ## test added thinking undef was causing float issues, but no

@testset "InitTests - Dimensions and initializations" begin
    tmprng = Xoshiro(100)
    BayesianNetworkRegression.initialize_variables!(st1, η, R, ν,tmprng, V)

    @test size(X_new) == (n,q)
    @test size(st1.S[1,:,1]) == (q,)
    @test size(st1.πᵥ[1,:,:]) == (R,3)
    @test size(st1.λ[1,:,1]) == (R,)
    @test issubset(st1.ξ[1,:,1],[0,1])
    @test size(st1.M[1,:,:]) == (R,R)
    @test size(st1.u[1,:,:]) == (R,V)
    @test size(st1.γ[1,:,1]) == (q,)

    @test st1.S[1,:,1] ≈ [0.03598930544575977, 0.0603934986743537, 0.1764484862629309, 0.3632764655421976, 0.007526019822996736, 0.05200735141854831, 0.5337420187246983, 0.2389742700569776, 0.07873781314603433, 0.005813391992081339] rtol=1.0e-5
    @test st1.πᵥ[1,:,:] ≈ [0.16524588619227237 0.49526550832060345 0.33948860548712395; 
                           0.7094090459301738 0.07150493775535315 0.21908601631447283; 
                           0.45011539695058267 0.3455177468263062 0.20436685622311124; 
                           0.7678359703331505 0.06286069677696832 0.16930333288988123; 
                           0.7057181482628861 0.11692100131589266 0.17736085042122113; 
                           0.6652178246740107 0.2351019604626032 0.09968021486338613; 
                           0.7879379077386442 0.08312760459028704 0.12893448767106888] rtol=1.0e-5
    @test st1.λ[1,:,1] ≈ [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.0] rtol=1.0e-5
    @test st1.ξ[1,:,1] ≈ [0.0, 0.0, 1.0, 0.0] rtol=1.0e-5
    @test st1.u[1,:,:] ≈ [-1.8797658114205273 -2.079633964812925 0.05348820909724081 -0.5238689838232432; 
                          -0.49694940830348294 0.7277052126479046 1.563178039164782 0.6759320383974253; 
                          0.9298498348548262 -0.07935739192235398 -1.927912173176923 -0.13281347312143535; 
                          -0.09331487617419446 2.343828549765799 -0.11594393195060496 0.9444115871949211; 
                          0.31596500538766026 0.9180771263263333 0.15608551934782897 0.8488950784351997; 
                          -0.1941962339656835 -0.5388183402012062 2.0630344707976436 -0.8239070141673399; 
                          0.8694982871251127 -1.0576654108700894 -0.32855545648869816 -1.7102088600932601] rtol=1.0e-5
    @test st1.M[1,:,:] ≈ [0.0852342766496677 0.03153769011672612 -0.06682865008440877 0.054657917564655954 0.008547301073842654 -0.005848894046437074 0.011656758505568781; 
                          0.03153769011672612 0.25074383867998706 -0.17805802968821277 0.2692995831348773 0.1399463582446182 -0.15137581133049688 0.000388038928376067; 
                          -0.06682865008440877 -0.17805802968821277 0.3880727588047287 -0.39203792152373457 -0.17150163985047806 0.24340582768795535 -0.09162059228959976;
                          0.054657917564655954 0.2692995831348773 -0.39203792152373457 0.5929947472582505 0.24624785742988375 -0.30449238316810134 0.12341379698135346; 
                          0.008547301073842654 0.1399463582446182 -0.17150163985047806 0.24624785742988375 0.26573778490925876 -0.1539646854141916 0.06793136946590451;
                          -0.005848894046437074 -0.15137581133049688 0.24340582768795535 -0.30449238316810134 -0.1539646854141916 0.43924459213667966 -0.04712498376383963; 
                          0.011656758505568781 0.000388038928376067 -0.09162059228959976 0.12341379698135346 0.06793136946590451 -0.04712498376383963 0.12465019663153737] rtol=1.0e-5   
    @test st1.γ[1,:,1] ≈ [-0.6772125390383251, 0.5217276649580689, 0.5896416917747658, 1.812155943139712, -1.1688634131409268, -0.5083863306034689, -0.4131214469386073, 0.44459083408559524, -1.003066124206758, -2.8316002679325583] rtol=1.0e-5
end


@testset "InitTests - Gibbs sampler" begin
    tmprng = Xoshiro(100)
    BayesianNetworkRegression.gibbs_sample!(st1, 2, X_new, y, V, η, ζ, ι, R, aΔ, bΔ, ν, tmprng)

    @test st1.τ²[2,1,1] ≈  38.81152677793215 rtol=1.0e-5
    @test st1.ξ[2,:,1] ≈ [1.0, 1.0, 1.0, 0.0] rtol=1.0e-5
    @test st1.u[2,:,:] ≈ [0.3351613575674969 -0.21170907345679477 -0.32369038900267955 -0.0; 0.41978376583080157 -0.040313568517733274 -0.4204145814407189 0.0; -0.31906094432326665 0.4123730514221248 0.7888162322519923 0.0; 0.21221407905763004 0.04847590295045605 -0.5425108531117492 -0.0; -0.4755649452487902 -0.09690783077298082 -0.8153329690533786 0.0; -1.0622430978374244 0.5167758614129232 0.26872275224012143 0.0; 0.16685167826966707 -0.3019379345751512 -0.28528397147497886 -0.0] rtol=1.0e-5
    @test st1.γ[2,:,1] ≈ [-1.0195362870924194, -0.17247936605795602, 0.09871798870703727, 4.96015848750843, -0.7742227763759377, -1.608558260210937, -12.68538266256592, 3.0316628573971935, -1.817391534674779, 0.4198349675836919] rtol=1.0e-5
    @test st1.θ[2,1,1] ≈ 0.5747524145732616 rtol=1.0e-5
    @test st1.Δ[2,1,1] ≈ 0.49955634650432323 rtol=1.0e-5
    @test st1.M[2,:,:] ≈ [0.21873583063662635 0.14460099215389707 0.01049920131095335 -0.08940361659306281 -0.03336892060353859 -0.16041700166918557 0.11933647184079167; 0.14460099215389707 0.3605382848978871 -0.04290938028603639 -0.18096176405494271 -0.03458419061558256 -0.35690752097356326 0.24340754981028548; 0.01049920131095335 -0.04290938028603639 0.25385212355344966 -0.021023432133085454 -0.010488379779242454 0.12968763574583253 -0.04287286257701994; -0.08940361659306281 -0.18096176405494271 -0.021023432133085454 0.24732775824489706 0.021245525046678076 0.20644500308103791 -0.13065959744568065; -0.03336892060353859 -0.03458419061558256 -0.010488379779242454 0.021245525046678076 0.25576338604642673 0.04683559179109453 0.11576861296812675; -0.16041700166918557 -0.35690752097356326 0.12968763574583253 0.20644500308103791 0.04683559179109453 0.5394353983247522 -0.2387140964085445; 0.11933647184079167 0.24340754981028548 -0.04287286257701994 -0.13065959744568065 0.11576861296812675 -0.2387140964085445 0.3607252482500785] rtol=1.0e-5
    @test st1.μ[2,1,1] ≈ 7.442353223748513 rtol=1.0e-5

    @test st1.S[2,:,1] ≈ [1.5260285922485526, 3.929973923857029, 2.939248450364925, 4.904831273171479, 1.2345727652261735, 0.5956096655849508, 2.898554513487604, 8.110346202704067, 1.776367911163374, 2.4465936495925837] rtol=1.0e-5
    @test st1.πᵥ[2,:,:] ≈ [0.1003190844877809 0.23473281639943488 0.6649480991127843; 0.0664886852898238 0.800536803324094 0.13297451138608216; 0.33020877422286576 0.5887410707801809 0.08105015499695331; 0.7782870802564602 0.1837886867332278 0.037924233010311836; 0.8454984613606632 0.06043314750074774 0.0940683911385889; 0.6491103692314161 0.27376028714985506 0.07712934361872897; 0.6805419673147755 0.1092033837467289 0.21025464893849563] rtol=1.0e-5
    @test st1.λ[2,:,1] ≈ [-1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0] rtol=1.0e-5
end

@testset "InitTests - Deconstructed Gibbs sampler" begin
    n = size(X_new,1)
    rng = Xoshiro(123)

    BayesianNetworkRegression.update_τ²!(st1, 3, X_new, y, V, rng)
    @test st1.τ²[3,1,1] ≈  18.556853437521433 rtol=1.0e-5

    BayesianNetworkRegression.update_u_ξ!(st1, 3, V, rng)
    @test st1.ξ[3,:,1] ≈ [0.0, 0.0, 0.0, 1.0] rtol=1.0e-5
    @test st1.u[3,:,:] ≈ [0.0 -0.0 -0.0 0.5816467793020965; 0.0 -0.0 0.0 0.7234746875589737; 0.0 -0.0 -0.0 0.4286772310139496; -0.0 0.0 -0.0 -0.21128392963939366; 0.0 -0.0 0.0 -0.1713056475892328; -0.0 0.0 -0.0 -1.0562979907213246; 0.0 -0.0 0.0 0.4644583698033836] rtol=1.0e-5

    BayesianNetworkRegression.update_γ!(st1, 3, X_new, y, n, rng)
    @test st1.γ[3,:,1] ≈ [6.235114835795371, -2.6242738746383436, 18.88901764998833, -8.352914258629298, -3.57564369319288, -0.9641674317617508, 0.9103293916596871, 0.39397908681396204, 5.961996957256365, -2.7640650109209157] rtol=1.0e-5

    BayesianNetworkRegression.update_D!(st1, 3, V, rng)
    BayesianNetworkRegression.update_θ!(st1, 3, ζ, ι, V, rng)
    @test st1.θ[3,1,1] ≈ 0.6223727453312841 rtol=1.0e-5

    BayesianNetworkRegression.update_Δ!(st1, 3, aΔ, bΔ, rng)
    @test st1.Δ[3,1,1] ≈ 0.22091872729697604 rtol=1.0e-5

    BayesianNetworkRegression.update_M!(st1, 3, ν, V, rng)
    @test st1.M[3,:,:] ≈ [0.36296093111651406 -0.051322653757942434 0.01764079476999576 -0.27403264309542325 -0.059162795008626555 -0.015404797950671718 -0.05845832212814916; -0.051322653757942434 0.3250909769292189 0.19814040708174077 0.15160490705919588 0.059976366732708807 -0.1404608971403459 0.07268930496099128; 0.01764079476999576 0.19814040708174077 0.3601371181727686 0.007543854449995574 -0.017705614694435157 -0.21795067980628877 0.025158651440986113; -0.27403264309542325 0.15160490705919588 0.007543854449995574 0.38071246303441053 0.052514072515877745 0.0035987086429847734 0.08909396430604509; -0.059162795008626555 0.059976366732708807 -0.017705614694435157 0.052514072515877745 0.09674804215549244 0.012689354178799971 -0.009593124950507048; -0.015404797950671718 -0.1404608971403459 -0.21795067980628877 0.0035987086429847734 0.012689354178799971 0.2121839603235589 -0.005615259649376689; -0.05845832212814916 0.07268930496099128 0.025158651440986113 0.08909396430604509 -0.009593124950507048 -0.005615259649376689 0.1541716082439721] rtol=1.0e-5

    BayesianNetworkRegression.update_μ!(st1, 3, X_new, y, n, rng)
    @test st1.μ[3,1,1] ≈ 8.521413707132442 rtol=1.0e-5

    BayesianNetworkRegression.update_Λ!(st1, 3, R, rng)
    @test st1.λ[3,:,1] ≈ [1.0, 1.0, -1.0, 0.0, 0.0, 0.0, 0.0] rtol=1.0e-5

    BayesianNetworkRegression.update_π!(st1, 3, η, R, rng)
    @test st1.πᵥ[3,:,:] ≈ [0.28187386451921054 0.6636434799816953 0.05448265549909421; 0.28230459849281037 0.31941535953386413 0.3982800419733255; 0.18156829106068195 0.36524188631725624 0.45318982262206187; 0.6638279735644856 0.13175074679685822 0.2044212796386561; 0.8478054130517755 0.08063214740237648 0.07156243954584808; 0.5929941267272864 0.28493154056244807 0.12207433271026547; 0.9632553763043383 0.004527689702442169 0.03221693399321952] rtol=1.0e-5
    @test st1.S[3,:,1] ≈ [3.5416377442730362, 15.994975070044156, 7.4188775719616284, 4.226397656800343, 0.1904399223263171, 2.500070923488004, 2.148793607057897, 2.1713710023521395, 2.2966694793978446, 0.2747489758399313] rtol=1.0e-5
end