## Initial tests for BayesianNetworkRegression.jl on toy data

## global seed
rng = Xoshiro(1234)

X = [[0, 1, 0, 1,
     1, 0, 1, 1,
     0, 1, 0, 0,
     0, 1, 0, 0],
    [0, 1, 1, 1,
     1, 0, 1, 1,
     1, 1, 0, 0,
     1, 1, 0, 0],
    [0, 0, 1, 0,
     0, 0, 1, 1,
     1, 1, 0, 0,
     0, 1, 0, 0],
    [0, 0, 1, 0,
     0, 0, 1, 1,
     1, 1, 0, 1,
     0, 1, 1, 0]]

Z = BayesianNetworkRegression.symmetrize_matrices(X)

y = ones(size(Z,1))*12 + rand(rng, Normal(0,2),size(Z,1))

η  = 1.01
ζ  = 1.0
ι  = 1.0
R  = 7
aΔ = 1.0
bΔ = 1.0
V = size(Z,1)
q = floor(Int,V*(V-1)/2)
n = size(Z,1)
ν = 10
total = 20

st1 = Table(τ² = Array{Float64,3}(undef,(total,1,1)), u = Array{Float64,3}(undef,(total,R,V)),
                  ξ = Array{Float64,3}(undef,(total,V,1)), γ = Array{Float64,3}(undef,(total,q,1)),
                  S = Array{Float64,3}(undef,(total,q,1)), θ = Array{Float64,3}(undef,(total,1,1)),
                  Δ = Array{Float64,3}(undef,(total,1,1)), M = Array{Float64,3}(undef,(total,R,R)),
                  μ = Array{Float64,3}(undef,(total,1,1)), λ = Array{Float64,3}(undef,(total,R,1)),
                  πᵥ= Array{Float64,3}(undef,(total,R,3)));

X_new = Array{Float64,2}(undef,n,q)
##X_new = rand(rng, Normal(0,2),n,q) ## test added thinking undef was causing float issues, but no

@testset "InitTests - Dimensions and initializations" begin
    tmprng = Xoshiro(100)
    BayesianNetworkRegression.initialize_variables!(st1, X_new, Z, η, R, ν,tmprng, V,true)

    @test size(X_new) == (n,q)
    @test size(st1.S[1,:,1]) == (q,)
    @test size(st1.πᵥ[1,:,:]) == (R,3)
    @test size(st1.λ[1,:,1]) == (R,)
    @test issubset(st1.ξ[1,:,1],[0,1])
    @test size(st1.M[1,:,:]) == (R,R)
    @test size(st1.u[1,:,:]) == (R,V)
    @test size(st1.γ[1,:,1]) == (q,)

    @test st1.S[1,:,1] ≈ [0.03598930544575977, 0.0603934986743537, 0.1764484862629309, 0.3632764655421976, 0.007526019822996736, 0.05200735141854831] rtol=1.0e-5
    @test st1.πᵥ[1,:,:] ≈ [0.6268594132276714 0.2806660623466782 0.09247452442565048; 0.3411939218833684 0.3908742967133088 0.2679317814033229; 
                           0.7124884573265206 0.13988225744010255 0.14762928523337687; 0.8001363526380453 0.12778865757249214 0.07207498978946264; 
                           0.7958448543057478 0.08068421309912785 0.12347093259512423; 0.7279161147249 0.1910718656875045 0.08101201958759545; 
                           0.7967568774411578 0.07967059905711153 0.12357252350173066] rtol=1.0e-5
    @test st1.λ[1,:,1] ≈ [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.0] rtol=1.0e-5
    @test st1.ξ[1,:,1] ≈ [0.0, 0.0, 1.0, 0.0] rtol=1.0e-5
    @test st1.u[1,:,:] ≈ [-0.1941962339656835 -0.5388183402012062 2.0630344707976436 -0.8239070141673399; 
                          0.8694982871251127 -1.0576654108700894 -0.32855545648869816 -1.7102088600932601; 
                          -2.079633964812925 0.05348820909724081 -0.5238689838232432 -0.6774139673081029; 
                          0.7277052126479046 1.563178039164782 0.6759320383974253 1.9716396834525778; 
                          -0.07935739192235398 -1.927912173176923 -0.13281347312143535 1.0300781996026194; 
                          2.343828549765799 -0.11594393195060496 0.9444115871949211 1.45165111906621; 
                          0.9180771263263333 0.15608551934782897 0.8488950784351997 -0.38152589587057145] rtol=1.0e-5
    @test st1.M[1,:,:] ≈ [0.1442865402877535 -0.09481943826900532 -0.07861994639191695 -0.0877147885884651 0.12845298526128307 0.16745948096672697 -0.12292653141778385; 
                         -0.09481943826900532 0.23603991587921208 0.00991981823198327 0.021377258434085583 -0.19078934923986388 -0.03917026162547057 0.02934280053962597; 
                         -0.07861994639191695 0.00991981823198327 0.45784928765401806 0.1893725673043783 0.13904563517532945 -0.6836742716006052 0.17715320975244722; 
                         -0.0877147885884651 0.021377258434085583 0.1893725673043783 0.2532017841481654 -0.018503888973659708 -0.4415298072104444 0.17817534724119077;
                          0.12845298526128307 -0.19078934923986388 0.13904563517532945 -0.018503888973659708 0.4913125271765574 -0.2101155433591583 -0.1658382531720953; 
                          0.16745948096672697 -0.03917026162547057 -0.6836742716006052 -0.4415298072104444 -0.2101155433591583 1.558186983690238 -0.3312618561739025; 
                          -0.12292653141778385 0.02934280053962597 0.17715320975244722 0.17817534724119077 -0.1658382531720953 -0.3312618561739025 0.32277286708233854] rtol=1.0e-5   
    @test st1.γ[1,:,1] ≈ [-0.2994919912961511, -0.5152427349491671, 1.346287067679127, -0.7536966812288193, 0.163223681016824, 0.3383808930405653] rtol=1.0e-5
end


@testset "InitTests - Gibbs sampler" begin
    tmprng = Xoshiro(100)
    BayesianNetworkRegression.gibbs_sample!(st1, 2, X_new, y, V, η, ζ, ι, R, aΔ, bΔ, ν, tmprng)

    @test st1.τ²[2,1,1] ≈  59.04862270391974 rtol=1.0e-5
    @test st1.ξ[2,:,1] ≈ [0.0, 0.0, 0.0, 1.0] rtol=1.0e-5
    @test st1.u[2,:,:] ≈ [0.0 -0.0 -0.0 0.38098010494465623; 
                          0.0 0.0 0.0 0.016595027834439287; 
                         -0.0 0.0 0.0 -0.27139402653131584; 
                         -0.0 0.0 -0.0 0.24347958098206696; 
                         -0.0 0.0 0.0 0.7103415480133298; 
                         0.0 -0.0 -0.0 -0.2947216722030207; 
                         0.0 0.0 0.0 -0.26598705434205006] rtol=1.0e-5
    @test st1.γ[2,:,1] ≈ [1.108033912695203, 2.290135279856229, 1.9248250490154222, 6.9201828008762245, -0.24179034551844483, -2.407649809585412] rtol=1.0e-5
    @test st1.θ[2,1,1] ≈ 0.6077385306057407 rtol=1.0e-5
    @test st1.Δ[2,1,1] ≈ 0.361381336888451 rtol=1.0e-5
    @test st1.M[2,:,:] ≈ [1.4942762805828098 -1.4840284735528855 0.4744969023464787 -0.5779879548225721 1.7300015268887339 -0.6907872433423182 0.5303723798839739; 
                         -1.4840284735528855 1.7172173505356731 -0.5121699752882573 0.5190500546053947 -1.7672814005156525 0.7821576867155932 -0.573130334281322; 
                         0.4744969023464787 -0.5121699752882573 0.27073757424070477 -0.18335446098592728 0.5547825321954869 -0.23581246967259398 0.23862572096590504; 
                         -0.5779879548225721 0.5190500546053947 -0.18335446098592728 0.36604007169632047 -0.7282458315599502 0.2200292408691362 -0.2135836953372944; 
                         1.7300015268887339 -1.7672814005156525 0.5547825321954869 -0.7282458315599502 2.1887013732554967 -0.8321371898779804 0.6714532585858384; 
                         -0.6907872433423182 0.7821576867155932 -0.23581246967259398 0.2200292408691362 -0.8321371898779804 0.4468066145938877 -0.2671238294007973; 
                         0.5303723798839739 -0.573130334281322 0.23862572096590504 -0.2135836953372944 0.6714532585858384 -0.2671238294007973 0.31160185567920273] rtol=1.0e-5
    @test st1.μ[2,1,1] ≈ 6.281130988188313 rtol=1.0e-5

    @test st1.S[2,:,1] ≈ [3.965781482942407, 0.4138545033725143, 0.33670615458413766, 10.920433199147293, 2.518218243432933, 1.299803959099133] rtol=1.0e-5
    @test st1.πᵥ[2,:,:] ≈ [0.5294859793946302 0.07370105811184667 0.39681296249352327; 
                           0.8351441395233271 0.15745127367118356 0.007404586805489282; 
                           0.4494686191531505 0.19536084069259416 0.35517054015425525; 
                           0.6438811865557731 0.11991738950400463 0.2362014239402223; 
                           0.8543972990625863 0.09231444276973017 0.05328825816768348; 
                           0.8286428797014725 0.054629268823281174 0.11672785147524624; 
                           0.6429687907868098 0.14441330046111814 0.2126179087520721] rtol=1.0e-5
    @test st1.λ[2,:,1] ≈ [0.0, 1.0, 0.0, 0.0, -1.0, 0.0, -1.0] rtol=1.0e-5
end

@testset "InitTests - Deconstructed Gibbs sampler" begin
    n = size(X_new,1)
    rng = Xoshiro(123)

    BayesianNetworkRegression.update_τ²!(st1, 3, X_new, y, V, rng)
    @test st1.τ²[3,1,1] ≈  10.946779261359621 rtol=1.0e-5

    BayesianNetworkRegression.update_u_ξ!(st1, 3, V, rng)
    @test st1.ξ[3,:,1] ≈ [0.0, 0.0, 0.0, 1.0] rtol=1.0e-5
    @test st1.u[3,:,:] ≈ [0.0 -0.0 0.0 1.4239177618361039; 
                         -0.0 0.0 -0.0 -1.6421630011411485; 
                         0.0 -0.0 -0.0 0.8660677575420249; 
                         -0.0 0.0 -0.0 -0.1346622216582799; 
                         0.0 -0.0 0.0 1.3104537001528014; 
                         -0.0 0.0 -0.0 -0.844647373734725; 
                         0.0 -0.0 0.0 0.3928471108084897] rtol=1.0e-5

    BayesianNetworkRegression.update_γ!(st1, 3, X_new, y, n, rng)
    @test st1.γ[3,:,1] ≈ [-3.8647500033363786, 0.758313670307333, 1.7720160879369873, 4.141739385601589, 1.7792901315674974, 0.5418053625846664] rtol=1.0e-5

    BayesianNetworkRegression.update_D!(st1, 3, V, rng)
    BayesianNetworkRegression.update_θ!(st1, 3, ζ, ι, V, rng)
    @test st1.θ[3,1,1] ≈ 0.4112716427237154 rtol=1.0e-5

    BayesianNetworkRegression.update_Δ!(st1, 3, aΔ, bΔ, rng)
    @test st1.Δ[3,1,1] ≈ 0.245909221045369 rtol=1.0e-5

    BayesianNetworkRegression.update_M!(st1, 3, ν, V, rng)
    @test st1.M[3,:,:] ≈ [0.5401749128406208 -0.3914778592517853 0.16398666286811245 -0.043069130868221964 0.6900227045677729 -0.3386549604754988 0.21910836725826252; 
                         -0.3914778592517853 1.7990367598893802 -0.7471075771632663 -0.21566485584686398 -1.9271144984603794 0.10561269596487911 0.235000838148329; 
                         0.16398666286811245 -0.7471075771632663 0.44287947435548636 0.08525626189094604 0.7922364360023403 -0.08094222496551175 -0.0775767461118362; 
                         -0.043069130868221964 -0.21566485584686398 0.08525626189094604 0.3297104846777991 0.19964683168389552 -0.064857385272347 -0.2770968305430351; 
                         0.6900227045677729 -1.9271144984603794 0.7922364360023403 0.19964683168389552 2.4055522739307826 -0.30663601608030605 -0.08832929188574548; 
                         -0.3386549604754988 0.10561269596487911 -0.08094222496551175 -0.064857385272347 -0.30663601608030605 0.38439917760533765 -0.09142728515810532; 
                         0.21910836725826252 0.235000838148329 -0.0775767461118362 -0.2770968305430351 -0.08832929188574548 -0.09142728515810532 0.4355839451730914] rtol=1.0e-5

    BayesianNetworkRegression.update_μ!(st1, 3, X_new, y, n, rng)
    @test st1.μ[3,1,1] ≈ 7.540458400371658 rtol=1.0e-5

    BayesianNetworkRegression.update_Λ!(st1, 3, R, rng)
    @test st1.λ[3,:,1] ≈ [1.0, 0.0, 1.0, -1.0, 0.0, -1.0, 1.0] rtol=1.0e-5

    BayesianNetworkRegression.update_π!(st1, 3, η, R, rng)
    @test st1.πᵥ[3,:,:] ≈ [0.2786985851180026 0.5405964365146348 0.18070497836736255; 
                           0.635893729558527 0.0033131623078872696 0.3607931081335859; 
                           0.5329722142753124 0.3333601428368205 0.13366764288786703; 
                           0.2814421178012408 0.45468857093237897 0.2638693112663801; 
                           0.9044060305783629 0.010265227411221106 0.08532874201041599; 
                           0.53686191755458 0.26420610046457516 0.19893198198084494; 
                           0.6235335909895693 0.3090849683066709 0.06738144070375976] rtol=1.0e-5
    @test st1.S[3,:,1] ≈ [0.7006056547188049, 4.482995331634634, 0.26499314902966065, 9.032273744726073, 3.4582110511879542, 4.648723562271958] rtol=1.0e-5
end