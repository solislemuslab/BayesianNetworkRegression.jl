# Test with test1.csv data

data_in = DataFrame(CSV.File(joinpath(@__DIR__, "data", "test1.csv")))
X = Matrix(data_in[:,1:190])
y = data_in[:,191]
R = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, nburn=200, nsamples=200, x_transform=false, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Test1 Generate Samples - Parameters" begin
    @test res.state.τ²[1:10] ≈ [1.0
    283.27517450843175
    129.67360332351137
     99.43404631499554
     88.1149403876931
     59.31009852903335
     48.925920670025846
     31.078275434519014
     21.604120048645918
     22.116285183826346] rtol=1.0e-5
    @test mean(res.state.τ²) ≈ 3.183175258380058 rtol=1.0e-5
    @test res.state.u[1:10,1:5,1] ≈ [2.18248      0.933176    0.144735  -0.335525    0.279549
    0.0801243   -0.133858   -0.441508  -0.0135671  -0.239922
   -1.45135     -0.918739   -1.23166    0.068389   -0.21306
   -0.585495    -1.11456    -0.634084  -0.205014   -0.179463
   -0.235889     0.328413   -0.320545  -0.223754    0.359096
   -0.423168    -0.886231   -0.374061   1.51656    -0.182667
   -0.326566    -0.0735496  -0.424336   0.794948    0.587931
   -0.155807    -0.522638   -0.429272   0.367158   -0.862078
    0.00523082  -0.238161   -0.245397   0.769217   -0.0534208
    0.267229    -0.144269    0.215119   0.384555   -0.181691] rtol=1.0e-5
    @test mean(res.state.u) ≈ 0.043354980802610445 rtol=1.0e-5
    @test res.state.ξ[1:10,1:4,1] ≈ [0.0  1.0  1.0  0.0
    1.0  1.0  0.0  1.0
    1.0  0.0  1.0  0.0
    1.0  0.0  0.0  0.0
    1.0  1.0  1.0  1.0
    1.0  1.0  1.0  1.0
    1.0  1.0  1.0  1.0
    1.0  1.0  1.0  1.0
    1.0  1.0  0.0  0.0
    1.0  0.0  0.0  1.0] rtol=1.0e-5
    @test mean(res.state.ξ) ≈ 0.842 rtol=1.0e-5
    @test res.state.γ[1:10,1:6,1] ≈ [5.71214     0.47493   0.709921    0.438594    2.20286     1.297
    -8.67267    -4.79344   3.58135    -9.50177   -13.1331      4.30269
     5.63048   -23.6472   24.8993     -1.76508   -28.128       3.24741
   -12.8749     47.516    11.1648    -10.4639      3.93258   -15.8988
    -0.162032    3.48547  -8.40747     9.17991    -7.25798    -6.14465
     0.810101   10.1267    2.7052      4.54723    -2.03734    -2.47145
     2.83225    12.3156   12.1255     -3.55286    -2.85176    -8.78932
    -0.361796   -3.07447   1.37859    -3.24466     0.372415    1.40946
     5.35932    -2.68708  -3.09568   -13.7596      0.555044   -0.49835
     0.972674    5.65618  -2.7609     -5.19381     1.00072    -0.895274] rtol=1.0e-5
    @test mean(res.state.γ) ≈ 0.755908425350159 rtol=1.0e-5
    @test res.state.S[1:10,1:6,1] ≈ [0.342334  0.086794  0.287651  0.115993  0.497022   0.0345492
    1.39865   1.16337   3.61811   4.26191   8.14574    0.948434
    0.793679  6.07591   2.62263   0.465408  1.21747    2.06474
    0.750243  4.07167   3.41282   4.4006    1.73382    1.42773
    0.120684  0.746817  1.41052   0.666545  2.14812    2.41793
    0.601389  0.516894  1.32877   1.1165    0.659506   1.46329
    0.62249   1.06257   2.10376   0.316579  0.794452   0.98797
    2.74708   1.97036   0.920376  2.56052   0.0241567  0.0639959
    0.89823   0.691534  0.800003  2.92632   0.0271965  0.0738392
    0.634163  0.444256  0.497522  0.73083   0.39851    0.00794216] rtol=1.0e-5
    @test mean(res.state.S) ≈ 2.4650144587683016 rtol=1.0e-5
    @test res.state.θ[1:10] ≈ [0.5
    0.9228932086535503
    0.9777133404464057
    1.338762775637482
    1.3301941623618843
    1.7715212992896943
    1.7992495544422071
    1.9663286264059254
    1.886774167745429
    2.634168062399439] rtol=1.0e-5
    @test mean(res.state.θ) ≈ 1.0073619793833175 rtol=1.0e-5
    @test res.state.Δ[1:10,:,1] ≈ [0.5
    0.5461985083980974
    0.6129597906126296
    0.6148953362458902
    0.801704563350792
    0.67063888603458
    0.7422953144454123
    0.7288662917418884
    0.5465287034242421
    0.43529997025739103] rtol=1.0e-5
    @test mean(res.state.Δ) ≈ 0.8191051759873049 rtol=1.0e-5
    @test res.state.M[1:10,:,1] ≈ [0.166031   0.00955539   0.0775286   -0.040192     -0.0879658
    0.190133   0.0962475    0.144206    -0.0522362    -0.0367777
    0.205083   0.116727     0.11856     -0.0644351     0.0279801
    0.172092   0.222743     0.155357    -0.19923       7.09975e-5
    0.149815   0.135958    -0.00706267  -0.130793      0.032029
    0.124304   0.0635618    0.0121179   -0.0875587     0.00143992
    0.117064  -0.0246963   -0.142165     0.0265185    -0.0309315
    0.152129  -0.0989886   -0.0978272    0.0821544    -0.0437755
    0.205263  -0.0253759   -0.12801      0.0728208    -0.0584188
    0.186927   0.0226237   -0.0583546   -0.000683522   0.00834868] rtol=1.0e-5
    @test mean(res.state.M) ≈ 0.07824163724924585 rtol=1.0e-5
    @test res.state.μ[1:10] ≈ [1.0
    0.923057157109211
    2.353584866994599
    2.645423041445531
    5.326642290893167
    4.074213044680367
    5.56377470405343
    6.055733685334297
    5.236511706095516
    6.010208507241863] rtol=1.0e-5
    @test mean(res.state.μ) ≈ 3.492831099100505 rtol=1.0e-5
    @test res.state.πᵥ[1:10,:,1] ≈ [0.0373815  0.639997  0.69578   0.465158  0.634261
    0.155939   0.390941  0.621788  0.296547  0.439971
    0.0760634  0.317628  0.389287  0.488414  0.83984
    0.24624    0.371099  0.671775  0.427901  0.970568
    0.235938   0.639737  0.758718  0.528034  0.848975
    0.457644   0.557866  0.492436  0.251717  0.760538
    0.431018   0.418133  0.578689  0.744057  0.57819
    0.588146   0.27112   0.42024   0.72022   0.804123
    0.8366     0.347686  0.789507  0.692523  0.984189
    0.136907   0.350076  0.77082   0.848772  0.906787] rtol=1.0e-5
    @test mean(res.state.πᵥ) ≈ 0.3333333333333333 rtol=1.0e-5
end

@testset "Test1 Generate Samples - Rhat" begin
    @test res.rhatξ.ξ[1:10] ≈ [ 1.1769705431007875
    1.0208355710680808
    1.0
    1.0
    1.0037540156302267
    1.0341350801716402
    0.9951348317355458
    1.0
    1.0
    1.0] rtol=1.0e-5
    @test res.rhatγ.γ[1:10] ≈ [1.0562988173669776
    1.1322467244291643
    1.2027627090484558
    1.0806121490835072
    0.9987829788489648
    0.999105367773903
    1.0615793091470598
    1.0762395637139224
    1.0963877770721115
    1.1023719750587524] rtol=1.0e-5
end

@testset "Test1 Generate Samples - Summary" begin
    out = Summary(res);
    @test out.edge_coef[1:10,:estimate] ≈ [ 0.5
    1.014
    0.122
   -0.977
   -0.332
   -0.255
    1.179
    0.477
   -0.161
    0.981] rtol=1.0e-5
    @test out.prob_nodes[1:10,:probability] ≈ [0.825
    0.975
    0.995
    1.0
    0.76
    0.7
    0.785
    1.0
    1.0
    1.0] rtol=1.0e-5
end