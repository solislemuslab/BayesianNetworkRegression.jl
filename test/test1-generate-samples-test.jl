# Test with test1.csv data

data_in = DataFrame(CSV.File(joinpath(@__DIR__, "data", "test1.csv")))
X = Matrix(data_in[:,1:190])
y = data_in[:,191]
R = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, nburn=200, nsamples=200, x_transform=false, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Test1 Generate Samples - Parameters" begin
    @test res.state.τ²[1:10] ≈ [1.0, 270.2376745842445, 98.30944122761936, 84.56326068633497, 
                                73.94547654383678, 64.42535438663045, 43.29428529193781, 
                                43.44178642786173, 38.91113496136172, 24.441470885675354] rtol=1.0e-5
    @test mean(res.state.τ²) ≈ 6.99638290789228 rtol=1.0e-5
    @test res.state.u[1:10,1:5,1] ≈ [0.33519453439801195 -0.391771390946401 -0.5861178900649967 0.9194671740989536 0.17684798699995558; 
                                     0.0 -0.0 0.0 0.0 0.0;
                                    -0.0 0.0 0.0 -0.0 0.0; 
                                    0.0 0.0 -0.0 -0.0 0.0; 
                                    -0.0 0.0 0.0 -0.0 -0.0; 
                                    0.0 0.0 0.0 0.0 0.0; 
                                    -0.0 -0.0 -0.0 -0.0 0.0; 
                                    0.0 -0.0 -0.0 -0.0 0.0; 
                                    0.04642415902896768 -0.41178475414541077 0.45539686652021066 -0.3560212993850747 0.45468381552928033; 
                                    0.79976966484389 -0.714851348966849 -0.8544656565930349 -0.1373922602860401 0.4296933551388872] rtol=1.0e-5
    @test mean(res.state.u) ≈ 0.03288394285264188 rtol=1.0e-5
    @test res.state.ξ[1:10,1:4,1] ≈ [1.0 1.0 0.0 0.0; 
                                     0.0 0.0 1.0 0.0; 
                                     0.0 0.0 0.0 0.0; 
                                     0.0 0.0 0.0 1.0; 
                                     0.0 0.0 1.0 0.0; 
                                     0.0 1.0 1.0 1.0; 
                                     0.0 1.0 1.0 1.0; 
                                     0.0 0.0 0.0 1.0; 
                                     1.0 1.0 0.0 1.0; 
                                     1.0 1.0 0.0 0.0] rtol=1.0e-5
    @test mean(res.state.ξ) ≈ 0.675375 rtol=1.0e-5
    @test res.state.γ[1:10,1:6,1] ≈ [0.6473770663728762 -1.8952454713161169 -0.353120667672305 0.7774913971449988 0.14132407433939292 -0.302949780119654; 
                                     5.441465075756193 3.9562212058825956 -9.54722673174037 -1.8687805592406488 -3.9956553933194314 -0.5586839375868073; 
                                     -13.787536039728844 11.32623123498331 -0.9822961531923475 -13.820549913155283 0.7850845676979867 -0.3909958495696777; 
                                     7.359255994706334 -0.8875035952685408 -8.517458578360863 -10.664422070981583 -2.9464544656579132 -5.759673934582005; 
                                     14.444455756309065 -10.118729407918112 -11.277109311424661 13.964350208871647 -4.254467389631137 -2.0224691978677924; 
                                     -3.4903275161015137 11.203776155888278 8.284342542219427 0.48131320061313154 2.6344074506322546 -2.147215510277737; 
                                     -2.358861729266041 9.991427439133538 3.5301655601794852 -6.104998659793116 -0.39240339647675815 2.2405792200493577; 
                                     -3.0336103434368704 -0.29795813304891716 10.723409175380612 -9.228635850466622 -7.607097957045396 -4.437335798468718; 
                                     -12.638938489091343 -0.690417330034062 0.06223017564868777 -12.403430224072906 -9.210653000363692 -3.776756891789843; 
                                     10.695920834997427 0.9888861193441447 -7.5626940640131055 -1.2487117838310609 1.947157968418859 3.110688760706508] rtol=1.0e-5
    @test mean(res.state.γ) ≈ 0.7226265952490109 rtol=1.0e-5
    @test res.state.S[1:10,1:6,1] ≈ [0.34233439253944253 0.08679402653200143 0.2876506724224301 0.11599335928212713 0.49702168040092953 0.03454919449156262; 
                                     0.9393083088158085 6.820539630778124 5.338972324632418 29.109152289179544 0.0662804501917611 0.009424670151933826; 
                                     1.356051633421827 13.329222686849967 6.691799378525099 1.3277145578902707 0.6958762968560792 0.7149646292091437; 
                                     2.6729702183162756 3.0152626675293455 0.5055990067577955 1.6109163140110945 0.06889859286354742 0.7862315398641077; 
                                     3.0842988256333244 0.2991450742194355 0.7412351603277223 2.1093896970026687 0.36376649978555076 0.05708486366781716; 
                                     1.2357133318465898 2.94937933944627 1.8039188144012719 0.33039116907225136 0.21169406032376142 0.19449152354645252; 
                                     0.17817960093690213 2.081910758380251 2.3850745264352557 1.456927825265873 2.7623859666903767 0.8872694246001842; 
                                     1.7804706217342898 0.021141009457794072 2.168037333011638 1.1241126404501025 5.584406512173434 0.4657025860008433; 
                                     1.5905643850424416 0.21859554942887294 0.3190483539571437 0.5837865810905715 0.7655643460248219 2.3832392424858813; 
                                     1.4338208216534198 3.647614470343222 1.693683333358363 3.574976883709548 0.517571391580878 0.7474719748513556] rtol=1.0e-5
    @test mean(res.state.S) ≈ 0.8156213643993457 rtol=1.0e-5
    @test res.state.θ[1:10] ≈ [0.5, 0.7704842603519642, 1.0710575509364493, 1.1044207410598665, 
                               1.1161729738125241, 1.1828182177174666, 1.3532356435698762, 
                               1.4586518717752777, 1.9096822899780976, 2.250028920101258] rtol=1.0e-5
    @test mean(res.state.θ) ≈ 3.361718526468219 rtol=1.0e-5
    @test res.state.Δ[1:10,:,1] ≈ [0.5; 
                                   0.608169938270678; 
                                   0.7763798624476896; 
                                   0.6601620567612518; 
                                   0.6503254816184656; 
                                   0.6056962817003928; 
                                   0.7097140370529404; 
                                   0.7625608287368898; 
                                   0.6959853177187962; 
                                   0.6503754572701048] rtol=1.0e-5
    @test mean(res.state.Δ) ≈ 0.6622801244941346 rtol=1.0e-5
    @test res.state.M[1:10,:,1] ≈ [0.2026265824783942 -0.07446974168190976 0.0015796600528544353 0.05801481344924079 -0.009069181210037759; 
                                   0.1022955335001316 -0.040933260538321734 -0.02941794333466171 0.07661080337546636 -0.030641331546802646; 
                                   0.09716998111408753 -0.08321624437370262 0.024936113293272773 0.09618383240907474 0.03426519284388131; 
                                   0.12372521778967163 -0.10728732205513028 -0.005558995717571376 0.15536168581260876 0.01772495509555207; 
                                   0.27739792096888494 -0.13298103502750191 0.018181746417536334 0.20802439248789198 -0.0012354202204141935; 
                                   0.4180207780636228 -0.114893335605936 0.09424088110465241 0.2172188981249687 0.0680502680989399; 
                                   0.7128459017054868 -0.2461811794991636 0.19943654089479246 0.4734930132874107 0.15741129735215578; 
                                   0.9466349700436097 0.1881191121609907 0.2201500967823135 0.8712127269507178 0.20717509241316276; 
                                   0.8417914529813239 0.04726430879480427 0.17960740977281323 0.7602450843014434 0.17505033723719957; 
                                   1.3720089794492285 0.005221717473873587 0.5905723523910172 1.0801978125353269 0.4501193195533384] rtol=1.0e-5
    @test mean(res.state.M) ≈ 0.06191342235101282 rtol=1.0e-5
    @test res.state.μ[1:10] ≈ [1.0, 2.584606243879358, 1.8238472931812444, 0.5316925631842857, 
                              -1.5309729089051203,-0.12183127918962056, 1.0298495229467228, 
                              1.799755204728088, 0.26824855650265655, 1.4218983003094314] rtol=1.0e-5
    @test mean(res.state.μ) ≈ -1.019414265109441 rtol=1.0e-5
    @test res.state.πᵥ[1:10,:,1] ≈ [0.03738151512076627 0.7920023667610172 0.870000613608928 0.5956427620796544 0.8094345046074453; 
                                    0.253673901283999 0.5996634787933264 0.762956340514772 0.7978622929543077 0.3815384103286699; 
                                    0.13285041952077842 0.6883552730683444 0.7503261554616734 0.7229842770834921 0.5795286133575386; 
                                    0.16553577181496879 0.6495248937172625 0.6948139008872276 0.7491031511054067 0.8377841236664229; 
                                    0.2364569781691327 0.3675508909404946 0.35910780784029783 0.9552657180208293 0.5483106297516719;
                                    0.29926314390885284 0.30817616509195717 0.518455659892225 0.7990480996921615 0.6959000882740688; 
                                    0.22484497965630013 0.3068395794950085 0.7430055607852697 0.7698865927727855 0.5598432420247528; 
                                    0.29059703228667033 0.6005465474234188 0.6399175049639299 0.6079809254272742 0.8213045269586007; 
                                    0.3351317800293105 0.05421035891265017 0.33393888479307415 0.7906420482564829 0.7687548976240551; 
                                    0.7350923349810022 0.33202520200859903 0.22331893104031578 0.7067781774184212 0.6572013351985563] rtol=1.0e-5
    @test mean(res.state.πᵥ) ≈ 0.3333333333333333 rtol=1.0e-5
end

@testset "Test1 Generate Samples - Rhat" begin
    @test res.rhatξ.ξ[1:10] ≈ [0.99498743710662, 1.0102566786223346, 1.0011199292934083, 
                              1.0, 0.9951597442231782, 1.000409752117175, 1.024543614623674, 
                              1.0, 1.0, 1.0] rtol=1.0e-5
    @test res.rhatγ.γ[1:10] ≈ [1.0158588627562672, 1.0439790276911698, 1.0228301234158788, 
                               1.0691606892870633, 1.05875560768302, 1.000442728055958,
                               1.0074547884353653, 0.996831610510686, 1.0410867108823771, 1.004253217303601] rtol=1.0e-5
end

@testset "Test1 Generate Samples - Summary" begin
    out = Summary(res);
    @test out.edge_coef[1:10,:estimate] ≈ [0.312, 1.142, 0.434, -0.793, -0.456, -0.595, 1.211, 0.475, -0.279, 0.485] rtol=1.0e-5
    @test out.prob_nodes[1:10,:probability] ≈ [0.81, 0.985, 0.93, 1.0, 0.825, 0.92, 0.825, 0.995, 0.995, 0.995] rtol=1.0e-5
end