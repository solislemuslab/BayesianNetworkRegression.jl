# Test with test1.csv data

data_in = DataFrame(CSV.File(joinpath(@__DIR__, "data", "test1.csv")))
X = Matrix(data_in[:,1:190])
y = data_in[:,191]
R = 5

res = BayesianNetworkRegression.generate_samples!(X, y, R, η=1.01,ζ=1.0,ι=1.0,aΔ=1.0,bΔ=1.0,
    ν=10, minburn=200, nsamp=200, maxburn=200, psrf_cutoff=1.2, x_transform=false, 
    suppress_timer=false, num_chains=1, seed=1234, purge_burn=nothing)

@testset "Test1 Generate Samples - Parameters" begin
    @test res.state.τ²[1:10] ≈ [1.0, 403.2081509580046, 171.39523201388116, 140.12164312014795, 123.67325230196695, 105.22203089897164, 119.14538789399445, 118.18969455887178, 93.94678613430695, 65.41250842804503] rtol=1.0e-5
    @test mean(res.state.τ²) ≈ 7.378747472829996 rtol=1.0e-5
    @test res.state.u[1:10,1:5,1] ≈ [2.1824824188249945 0.933176457877094 0.1447351821766334 -0.33552548134667304 0.27954876709092763; 0.4774264733115842 -0.19962901706042913 -0.36599005400562223 -0.10475159584270309 -0.41844132274543194; -1.6575083793780887 -0.8282477732887047 -1.2716969574236952 0.09178281764252692 -0.19511391019491106; 0.0 -0.0 -0.0 0.0 0.0; 0.15097753483132348 -0.3221706697806418 0.06792862893940377 -0.31158469783964265 0.14025333174813687; -0.3383731541019974 -0.9424434444540485 -0.009134746088116916 0.4255856698835925 0.09939206011228546; 0.9642992572719356 0.9808028616503299 0.9163011299274441 -0.5352870190706476 -0.1515724619237373; 1.1464973444570308 1.0616584207401338 1.0076227932396795 -0.6268223432398963 -0.48551987815495123; 1.8154693053992985 1.864960939985492 0.525166682841103 -0.9123863556734464 0.2149891151406687; 0.6652939065051415 0.6440422086459806 -0.7831144785268807 -0.3770553495954885 -0.04535406569071773] rtol=1.0e-5
    @test mean(res.state.u) ≈ 0.00032079267036032495 rtol=1.0e-5
    @test res.state.ξ[1:10,1:4,1] ≈ [0.0 1.0 1.0 0.0; 1.0 1.0 0.0 1.0; 1.0 0.0 1.0 0.0; 0.0 1.0 1.0 1.0; 1.0 0.0 1.0 0.0; 1.0 1.0 0.0 1.0; 1.0 0.0 0.0 1.0; 1.0 1.0 1.0 1.0; 1.0 1.0 1.0 1.0; 1.0 1.0 1.0 1.0] rtol=1.0e-5
    @test mean(res.state.ξ) ≈ 0.5146052631578948 rtol=1.0e-5
    @test res.state.γ[1:10,1:6,1] ≈ [5.656828040604767 4.712549956687797 -0.11882191112066187 0.5971352076537104 1.859861966482442 2.9534765907475125; -4.532967768608436 -10.01170290030571 -3.2772152419990492 -2.4952902448056995 3.3653109424160226 0.16509860193837061; 5.707230906356717 18.755439918126648 7.0134706049465585 -17.116097390505995 -1.7252710929349693 10.473798899011895; -0.8594866238040346 -4.261189574176287 -8.474227938426521 -1.8559637581522672 3.3330616460395808 25.129827587803874; -5.446806210632432 -5.086530847626516 -10.249750324200496 -5.677746081243414 2.0990261791244356 -0.36898075586794477; -0.9884117675123616 9.126319382483272 2.502333062547855 4.700760101427319 -14.220969728481787 0.23099296062386282; -14.625519000419548 4.018511039443893 0.22883894735756716 0.6429037445696879 -5.961912971371121 3.1301008530451124; 6.309584279914163 -9.304888876663231 -2.0019553246878603 -5.071474540742042 -7.944664021270391 -3.6924230672861587; 2.908697513425765 20.286984720202334 2.212064301295878 2.617277446082876 2.6901524930306477 8.218789032018334; -2.6148500103797363 5.4954334372411795 -0.3047938106806181 -10.396947250798759 -4.053615543319415 2.1738117901768343] rtol=1.0e-5
    @test mean(res.state.γ) ≈ 0.49614806881018914 rtol=1.0e-5
    @test res.state.S[1:10,1:6,1] ≈ [0.34233439253944253 0.08679402653200143 0.2876506724224301 0.11599335928212713 0.49702168040092953 0.03454919449156262; 0.1013208307695953 1.2153714248017797 1.0951196486831765 0.6419501487816157 3.5542758327589232 2.248313920932603; 1.527196210476757 2.446844167005188 2.3436323939498296 5.5244546804539265 0.11711481562281248 2.813890200364471; 0.6342786312860336 2.119338271214523 0.6713224660228256 0.08579772636123989 0.19765463237276568 4.769536319216753; 1.414183187982843 0.8334472199757921 3.553888046615202 0.08227012926739186 1.3594562098085279 0.0007406718079795236; 3.708986696577048 0.3587325581455868 1.0069633822979742 0.8606339541054006 1.6695144453101567 0.15907741936241956; 1.2087582065708744 1.290590014898302 0.03197276479347073 0.14783791487104314 0.8808840080130005 0.1105749942682676; 0.1195934222810477 2.2329170495504704 0.11253487010070574 0.03530593018054363 0.9147136708203562 1.9258546228615885; 0.46162574400211454 1.6999620943726335 0.18502393892094826 0.31614017782145926 0.2532967313984997 1.44423752096992; 0.8972385779329713 0.16872624865874525 0.10291785800128642 0.9700983010267545 0.2961090362562451 0.0459088414337798] rtol=1.0e-5
    @test mean(res.state.S) ≈ 1.4004167204182842 rtol=1.0e-5
    @test res.state.θ[1:10] ≈ [0.5, 1.0449752640126548, 1.2973147770029816, 1.538949566090532, 1.5586372801046857, 1.7530141690945429, 1.8245083193817468, 1.8320102499057052, 2.198587061868249, 3.0431809908091267] rtol=1.0e-5
    @test mean(res.state.θ) ≈ 1.697720042690134 rtol=1.0e-5
    @test res.state.Δ[1:10,:,1] ≈ [0.5; 0.5245798341239089; 0.5983488371144464; 0.5706782079373126; 0.6868393983393126; 0.7572896813150864; 0.7802355685289891; 0.7255672530907318; 0.8014142067673461; 0.7316432511269643] rtol=1.0e-5
    @test mean(res.state.Δ) ≈ 0.51501864891054 rtol=1.0e-5
    @test res.state.M[1:10,:,1] ≈ [0.3232874689515681 0.013333639078571423 0.10818376215267643 -0.056084039874557054 -0.12274782961144448; 0.2690882291064241 0.17094161484852166 0.22874219105436938 -0.0893524403909439 -0.06951856937205729; 1.3269502551948906 0.8282770258488429 0.7750454622582814 -0.7867307941508033 0.1820078780674226; 4.386630693392684 2.6312707628116128 2.5082166844834646 -2.0554413895956016 0.38764736265198113; 0.8918966885373503 0.5889158745745188 0.4491344289072787 -0.5847529337387861 -0.07346123332074334; 1.0393370790099574 0.31514314252639775 0.764083790028259 -0.5887661536304765 0.10863608995891141; 0.8337901872788023 0.8153737650182995 0.4576785445966428 -0.5908879054093686 -0.04135916658852234; 1.2938028946767348 1.1219310494002248 0.5889545054197038 -0.9052762439414275 -0.09936112572159975; 1.2356584848995618 1.0485142654036785 0.494394715026558 -0.9726065189171802 -0.0177143197462713; 1.0739329517221405 1.0010121587283618 0.4266793202565187 -0.7716413833355321 0.1505550002223177] rtol=1.0e-5
    @test mean(res.state.M) ≈ 0.05430477549726458 rtol=1.0e-5
    @test res.state.μ[1:10] ≈ [1.0, -0.14046893325676557, 0.8122702775303744, 4.815653585860768, 5.819421264517861, 6.6989603440635666, 7.677356213960002, 8.707222077638322, 10.512225568958, 12.47496062999526] rtol=1.0e-5
    @test mean(res.state.μ) ≈ 3.555118370674512 rtol=1.0e-5
    @test res.state.πᵥ[1:10,:,1] ≈ [0.03738151512076627 0.6399968074120261 0.6957798531378172 0.4651575877160317 0.6342606654254235; 0.15593918356108247 0.39094110715493063 0.6217878388113917 0.2965471411634927 0.43997130212874236; 0.17771398879758832 0.3824738637023124 0.36269082007932163 0.47289557310760666 0.8227557432425979; 0.337830859560938 0.8137530117549471 0.1548272118386434 0.5052327885020537 0.5563873820559353; 0.1020195243659489 0.46467614127427337 0.3894030281412308 0.7681082338151923 0.8164420290013884; 0.503309123314452 0.41200252755418565 0.6368737290308516 0.7218080363927506 0.6478965473702266; 0.0006411409384278933 0.6349324775022556 0.35579054741525756 0.8633132549596633 0.36107149086344337; 0.02495584084217352 0.44506786878674726 0.4978837814503623 0.716435644251091 0.42613541267953836; 0.6502381893742817 0.5337919212183775 0.45949654043352073 0.8982181884524861 0.7622737697396298; 0.14375443834172735 0.35007553010784387 0.770819677681413 0.8487720403910969 0.9067870498604756] rtol=1.0e-5
    @test mean(res.state.πᵥ) ≈ 0.3333333333333333 rtol=1.0e-5
end

@testset "Test1 Generate Samples - Rhat" begin
    @test res.rhatξ.ξ[1:10] ≈ [1.0073100478208201, 0.9986703149799986, 0.9986283872414606, 0.9966340868671862, 1.0052516600540766, 0.9950881596292352, 0.997593075667257, 0.995391328918305, 0.995391328918305, 0.9987956104706939] rtol=1.0e-5
    @test res.rhatγ.γ[1:10] ≈ [0.9951818571999925, 0.9950337567515926, 1.0099082833693194, 1.016816408491932, 1.0172651615119641, 0.9967604148778921, 0.9950209246554249, 1.0269992080190427, 1.0035238045748338, 1.007485531913942] rtol=1.0e-5
end

@testset "Test1 Generate Samples - Summary" begin
    out = Summary(res);
    @test out.edge_coef[1:10,:estimate] ≈ [0.339, 1.325, -0.004, -0.851, -0.861, -0.943, 1.341, -0.025, 0.293, 0.109] rtol=1.0e-5
    @test out.prob_nodes[1:10,:probability] ≈ [0.435, 0.42, 0.44, 0.41, 0.42, 0.445, 0.395, 0.44, 0.44, 0.38] rtol=1.0e-5
end